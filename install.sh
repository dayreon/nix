#!/bin/sh
set -e

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å
export LANG=ru_RU.UTF-8
export LC_ALL=ru_RU.UTF-8

# –ù–∞—à–∞ –∫—Ä—É—Ç–∞—è ASCII-–∞—Ä—Ç –∑–∞—Å—Ç–∞–≤–∫–∞
cat << "EOF"

‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üöÄ –ü–æ–≥–Ω–∞–ª–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É, –±—Ä–∞—Ç–∞–Ω!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EOF

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ —Ä—É—Ç–∞
if [ "$(id -u)" -ne 0 ]; then
    echo "‚ùå –ù—É–∂–Ω—ã –ø—Ä–∞–≤–∞ —Ä—É—Ç–∞! –ó–∞–ø—É—Å—Ç–∏ —á–µ—Ä–µ–∑ sudo"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ NixOS
if [ ! -f /etc/NIXOS ]; then
    echo "‚ùå –≠—Ç–æ –Ω–µ NixOS! –¢—ã –∫—É–¥–∞ –º–µ–Ω—è –ø–∏—Ö–∞–µ—à—å?"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ WiFi
setup_wifi() {
    echo "üì° –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º WiFi..."

    # –ó–∞–ø—É—Å–∫–∞–µ–º wpa_supplicant
    systemctl start wpa_supplicant

    # –ñ–¥–µ–º –ø–æ–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è
    sleep 2

    # –°–∫–∞–Ω–∏—Ä—É–µ–º —Å–µ—Ç–∏
    echo "üîç –ò—â–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ç–∏..."
    iwctl station wlan0 scan
    sleep 2

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ç–µ–π
    echo "\nüì∂ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ç–∏:"
    iwctl station wlan0 get-networks

    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è —Å–µ—Ç–∏
    printf "\nüí≠ –í–≤–µ–¥–∏ –∏–º—è WiFi —Å–µ—Ç–∏: "
    read -r SSID

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è (iwctl —Å–∞–º —Å–ø—Ä–æ—Å–∏—Ç –ø–∞—Ä–æ–ª—å)
    echo "üîå –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ $SSID..."
    iwctl station wlan0 connect "$SSID"

    # –ñ–¥–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    echo "‚è≥ –ñ–¥–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
    sleep 5
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
if ! ping -c 1 google.com >/dev/null 2>&1; then
    echo "‚ùå –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞!"
    echo "üí° –î–∞–≤–∞–π –Ω–∞—Å—Ç—Ä–æ–∏–º WiFi..."
    setup_wifi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑
    if ! ping -c 1 google.com >/dev/null 2>&1; then
        echo "‚ùå –í—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞."
        exit 1
    fi
fi

echo "üîß –°—Ç–∞–≤–∏–º –Ω—É–∂–Ω—ã–µ —Ç—É–ª–∑—ã..."
nix-shell -p git nushell --run "\
    echo 'üì¶ –ö–∞—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥...' && \
    git clone https://github.com/decard2/nix /tmp/nixos-config && \
    cd /tmp/nixos-config && \
    echo '‚öôÔ∏è  –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º—É...' && \
    ./install.nu
"

echo "
‚ú® –í—Å—ë –≥–æ—Ç–æ–≤–æ, –±—Ä–∞—Ç–∏—à–∫–∞!
üí° –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Å—å –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Å—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π!
   –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫ - –ø–∏—à–∏ –≤ issues, –ø–æ–º–æ–∂–µ–º!
"
